<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alert Investigation – Netlify build failure: brands/[slug].astro</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      border-bottom: 2px solid #eee;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
    h1 {
      margin-top: 0;
      color: #2c3e50;
    }
    .meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    .meta-item {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
    }
    .meta-item h4 {
      margin: 0 0 5px 0;
      color: #6c757d;
      font-size: 0.9rem;
      text-transform: uppercase;
    }
    .meta-item p {
      margin: 0;
      font-weight: 500;
    }
    .badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
    }
    .badge-sev2 {
      background-color: #f39c12;
    }
    section {
      margin-bottom: 30px;
    }
    h2 {
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 5px;
    }
    pre {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      font-size: 0.9rem;
    }
    code {
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background-color: #f1f3f5;
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.9em;
    }
    .code-block {
      margin: 15px 0;
    }
    .code-header {
      background-color: #e9ecef;
      padding: 5px 10px;
      border-top-left-radius: 4px;
      border-top-right-radius: 4px;
      font-weight: 600;
      font-size: 0.8rem;
    }
    .code-content {
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-top: none;
      border-bottom-left-radius: 4px;
      border-bottom-right-radius: 4px;
      padding: 10px;
      overflow-x: auto;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.9rem;
    }
    ul {
      padding-left: 20px;
    }
    li {
      margin-bottom: 5px;
    }
    .timeline {
      border-left: 2px solid #dee2e6;
      padding-left: 20px;
      margin-left: 10px;
    }
    .timeline-item {
      position: relative;
      margin-bottom: 20px;
    }
    .timeline-item::before {
      content: "";
      position: absolute;
      left: -26px;
      top: 5px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: #6c757d;
    }
    .timeline-time {
      font-weight: 600;
      color: #495057;
    }
    footer {
      margin-top: 40px;
      padding-top: 20px;
      border-top: 2px solid #eee;
      font-size: 0.9rem;
      color: #6c757d;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <h1>Alert Investigation – Netlify build failure: brands/[slug].astro</h1>
    <div class="meta">
      <div class="meta-item">
        <h4>Severity</h4>
        <p><span class="badge badge-sev2">SEV-2</span></p>
      </div>
      <div class="meta-item">
        <h4>Started</h4>
        <p id="current-time">Current UTC Time</p>
      </div>
      <div class="meta-item">
        <h4>On-call</h4>
        <p>Factory Droid (Slack: @factory-droid)</p>
      </div>
    </div>
  </header>

  <section>
    <h2>Executive Summary</h2>
    <p>Because the brand page used TS-incompatible syntax in an Astro frontmatter virtual TS module (object spread in JSON.stringify and an optional-chaining call), esbuild choked early in parsing → Vite build failed at brands/[slug].astro line 2.</p>
  </section>

  <section>
    <h2>Root Cause Analysis</h2>
    <h3>Primary Hypothesis</h3>
    <p>esbuild parsing failure of Astro frontmatter/virtual TS due to modern syntax combination (object spread inside JSON.stringify and optional-chaining call), causing the "Expected '}' but found '.'" error.</p>
    
    <h3>Contributing Factors</h3>
    <ul>
      <li>Netlify's build toolchain parsing the frontmatter as lang.ts</li>
      <li>Fragile combination of syntax in server-side evaluation</li>
      <li>Previous fragments (&lt;&gt; ... &lt;/&gt;) in template may also upset the parser</li>
    </ul>
  </section>

  <section>
    <h2>Evidence</h2>
    
    <h3>Log Snippet</h3>
    <pre>[2m17:44:32[22m [34m[vite][39m [32m✓[39m 6 modules transformed.
[31m[1m17:44:32[22m [ERROR] [vite][39m [31m✗[39m Build failed in 13ms
Expected "}" but found "."
  [1mLocation:[22m
    [4m/opt/build/repo/src/pages/brands/[slug].astro?astro&type=script&index=0&lang.ts:2:29[24m
  [1mStack trace:[22m
[2m    at failureErrorWithLog (/opt/build/repo/node_modules/esbuild/lib/main.js:1467:15)
    at responseCallbacks.&lt;computed&gt; (/opt/build/repo/node_modules/esbuild/lib/main.js:603:9)
    at Socket.readFromStdout (/opt/build/repo/node_modules/esbuild/lib/main.js:581:7)
    at addChunk (node:internal/streams/readable:561:12)
    at Readable.push (node:internal/streams/readable:392:5)[22m</pre>

    <h3>Code Reference</h3>
    <p>File: <code>src/pages/brands/[slug].astro</code></p>
    
    <div class="code-block">
      <div class="code-header">Before (problematic)</div>
      <div class="code-content">
JSON.stringify({
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: brand.brand,
  url: `https://vitaminbrandindex.com/brands/${brand.slug}/`,
  ...(officialUrl ? { sameAs: [officialUrl] } : {})
})

window.plausible?.('Tag Click', { props: { tag, brand } })

{officialUrl && (
  <>
    &lt;dt>Official website&lt;/dt>
    &lt;dd>&lt;a href={officialUrl} target="_blank" rel="noopener noreferrer">{officialUrl}&lt;/a>&lt;/dd>
  </>
)}
      </div>
    </div>

    <div class="code-block">
      <div class="code-header">After (fixed)</div>
      <div class="code-content">
// Pre-build JSON-LD object without spread syntax
const ldOrg = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: brand.brand,
  url: `https://vitaminbrandindex.com/brands/${brand.slug}/`,
};
if (officialUrl) {
  ldOrg.sameAs = [officialUrl];
}

// In script tag
JSON.stringify(ldOrg)

// Safe window access
if (window && window.plausible) {
  window.plausible('Tag Click', { props: { tag, brand } });
}

// No fragment shorthand
{officialUrl ? &lt;dt>Official website&lt;/dt> : null}
{officialUrl ? (
  &lt;dd>
    &lt;a href={officialUrl} target="_blank" rel="noopener noreferrer">
      {officialUrl}
    &lt;/a>
  &lt;/dd>
) : null}
      </div>
    </div>
  </section>

  <section>
    <h2>Proposed Fix</h2>
    
    <h3>Immediate Mitigation</h3>
    <p>Remove spread/optional-chaining/fragment shorthand; rebuild.</p>
    
    <h3>Short-term Fix</h3>
    <p>Prebuild ld+json object (no spread), guard Plausible call, avoid fragment shorthand; commit/push and redeploy.</p>
    
    <h3>Long-term Solution</h3>
    <ul>
      <li>Standardize Astro frontmatter to plain JS (no TS/advanced syntax) for production builds</li>
      <li>Add CI check to bundle sample pages</li>
      <li>Pin toolchain versions</li>
    </ul>
  </section>

  <section>
    <h2>Incident Timeline</h2>
    <div class="timeline">
      <div class="timeline-item">
        <div class="timeline-time">17:44:32 UTC</div>
        <div class="timeline-content">
          Netlify/Vite build failed with error: "Expected '}' but found '.'" in brands/[slug].astro line 2.
        </div>
      </div>
    </div>
  </section>

  <footer>
    <p>Generated: <span id="generation-date">September 16, 2025</span></p>
  </footer>

  <script>
    // Update the current time in UTC
    document.getElementById('current-time').textContent = new Date().toUTCString();
    document.getElementById('generation-date').textContent = new Date().toUTCString();
  </script>
</body>
</html>
